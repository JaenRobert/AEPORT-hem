[Console]::OutputEncoding = [System.Text.Encoding]::UTF8
Write-Host "=== üöÄ AESI Deploy v1.3 (NIMB AutoVerify Engine) ===" -ForegroundColor Cyan

# ====== 1. UPPDATERA & EXPORTERA ======
if (Test-Path ".\update_nimb.py") {
    Write-Host "üîß K√∂r update_nimb.py..." -ForegroundColor Yellow
    python .\update_nimb.py
} else {
    Write-Host "‚ö†Ô∏è  Ingen update_nimb.py hittad ‚Äì hoppar √∂ver uppdatering." -ForegroundColor DarkYellow
}

# ====== 2. UPPDATERA DATUM ======
$indexPath = ".\index.html"
if (Test-Path $indexPath) {
    $timestamp = (Get-Date).ToString("yyyy-MM-dd HH:mm:ss")
    Write-Host "üïí Uppdaterar datum i banner: $timestamp" -ForegroundColor Yellow
    $content = Get-Content $indexPath -Raw
    $updated = $content -replace '(?<=<span id="status-time">).*?(?=</span>)', $timestamp
    $updated | Set-Content -Path $indexPath -Encoding UTF8
    Write-Host "‚úÖ index.html uppdaterad" -ForegroundColor Green
}

# ====== 3. GIT OPERATIONS ======
Write-Host "üì¶ L√§gger till filer..." -ForegroundColor Yellow
git add .

$date = Get-Date -Format "yyyy-MM-dd HH:mm"
$commitMsg = "AutoDeploy v1.3 ‚Äì $date"
Write-Host "üìù Commit: $commitMsg" -ForegroundColor Yellow
git commit -m "$commitMsg"

Write-Host "üåê Pushar till GitHub..." -ForegroundColor Yellow
git push

if ($LASTEXITCODE -ne 0) {
    Write-Host "‚ùå N√•got gick fel vid push." -ForegroundColor Red
    exit
}

# ====== 4. NETLIFY AUTO VERIFY ======
Write-Host "üõ∞  V√§ntar p√• att Netlify ska bygga klart..." -ForegroundColor DarkGray
Start-Sleep -Seconds 5

$siteUrl = "https://aesi-portal.netlify.app"
$timeout = 180   # 3 minuter
$interval = 10
$elapsed = 0
$success = $false

while ($elapsed -lt $timeout) {
    try {
        $response = Invoke-WebRequest -Uri $siteUrl -UseBasicParsing -ErrorAction Stop
        if ($response.StatusCode -eq 200 -and $response.Content -match "√ÜSI Portal|AESI") {
            Write-Host "‚úÖ Netlify build klar! Portalen svarar korrekt." -ForegroundColor Green
            $success = $true
            break
        }
    } catch {
        # Ignorera fel tills sidan svarar
    }
    Write-Host "‚åõ V√§ntar... ($elapsed s)" -ForegroundColor DarkGray
    Start-Sleep -Seconds $interval
    $elapsed += $interval
}

if (-not $success) {
    Write-Host "‚ö†Ô∏è  Timeout ‚Äì kunde inte verifiera portalen inom $timeout sekunder." -ForegroundColor DarkYellow
} else {
    Write-Host "üåç √ñppnar portalen i webbl√§saren..." -ForegroundColor Cyan
    Start-Process $siteUrl
}

# ====== 5. PIPELINE STATUS ======
Write-Host ""
Write-Host "------------------------------------------" -ForegroundColor DarkGray
Write-Host " AESI PIPELINE v1.3 ‚Äì NIMB AutoVerify " -ForegroundColor Magenta
Write-Host " [Local Update] ‚Üí [GitHub Push] ‚Üí [Netlify Build] ‚Üí [Portal Ready]" -ForegroundColor Gray
Write-Host "------------------------------------------" -ForegroundColor DarkGray
Write-Host " ‚úÖ AESI Deploy v1.3 ‚Äì NIMB Live Engine Synced" -ForegroundColor Green
Write-Host "------------------------------------------" -ForegroundColor DarkGray
