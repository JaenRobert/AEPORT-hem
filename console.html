<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√ÜSI | MASTER CONSOLE v3.7</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;500;600;800&family=Merriweather:ital,wght@0,300;0,400;0,700;1,300&display=swap" rel="stylesheet">
    <style>
        :root { --bg-dark: #050505; --sidebar-bg: #0a0a0a; --border: #262626; --accent: #6366f1; --text-main: #d4d4d4; }
        body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Inter', sans-serif; overflow: hidden; height: 100vh; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .serif { font-family: 'Merriweather', serif; }

        /* General Layout */
        .console-grid { display: grid; grid-template-columns: 280px 1fr 400px; grid-template-rows: 60px 1fr; height: 100vh; }
        .header { grid-column: 1 / -1; background: #000; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 1.5rem; z-index: 50; }

        /* SIDEBAR & MENU */
        .left-sidebar { background: var(--sidebar-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }
        .team-dock { padding: 1rem; border-bottom: 1px solid var(--border); background: #080808; }
        .node-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; }
        .mini-node { background: #111; border: 1px solid #222; border-radius: 4px; padding: 0.5rem; text-align: center; font-size: 0.65rem; color: #666; }
        .node-dot { width: 6px; height: 6px; border-radius: 50%; margin: 0 auto 4px; }
        .menu-scroll { overflow-y: auto; padding: 1.5rem; flex-grow: 1; }
        .menu-link { display: flex; align-items: center; gap: 0.75rem; padding: 0.4rem 0; font-size: 0.8rem; color: #888; border-left: 2px solid transparent; padding-left: 0.75rem; margin-left: -0.75rem; transition: all 0.2s; }
        .menu-link:hover { color: #fff; border-left-color: #444; }

        /* DOCUMENT AREA */
        .document-area { 
            background: #050505; 
            overflow-y: auto; 
            padding: 4rem 6rem; 
            position: relative;
        }
        /* FIX: Ensure the entire area is technically editable */
        [contenteditable]:focus { outline: none; }
        .editable-section { padding: 1rem; margin: -1rem 0; transition: all 0.2s; }
        .editable-section:focus-within { 
            border-left: 2px solid var(--accent); 
            background: rgba(99, 102, 241, 0.03);
        }
        .prose-text { max-width: 75ch; margin: 0 auto; color: #d1d5db; line-height: 1.8; }
        h1 { font-size: 2.5rem; font-weight: 900; color: white; margin-bottom: 1.5rem; }
        h2 { font-size: 1.75rem; font-weight: 800; color: white; margin-top: 3.5rem; margin-bottom: 1rem; border-bottom: 1px solid #222; padding-bottom: 0.5rem; }
        blockquote { border-left: 4px solid var(--accent); padding-left: 1rem; color: #a5b4fc; margin: 2rem 0; font-style: italic; background: rgba(99,102,241,0.05); padding: 1rem; border-radius: 0 4px 4px 0; }

        /* CHAT/OPS PANEL */
        .ops-panel { background: #0c0c0c; border-left: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }
        .chat-area { flex-grow: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 0.8rem; }
        .input-area { background: #000; border-top: 1px solid var(--border); padding: 1rem; flex-shrink: 0; }
        .pulse-input { width: 100%; background: #111; border: 1px solid #333; color: white; padding: 0.75rem; border-radius: 0.5rem; font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; resize: none; outline: none; }

        /* NODE CHAT COLORS */
        .dot.offline { background: #ef4444; }
        .msg-node { border-left: 3px solid; border-color: #333; }
        .node-JEMMIN { border-color: #a855f7; } 
        .node-REFLEX { border-color: #3b82f6; } 
        .node-CLAUDE { border-color: #ef4444; } 
        .node-HAFTED { border-color: #78716c; }
        .node-SMILE { border-color: #eab308; }
        .node-ERNIE { border-color: #10b981; } 
        
        .text-JEMMIN { color: #a855f7; }
        .text-REFLEX { color: #3b82f6; }
        .text-CLAUDE { color: #ef4444; }
        .text-HAFTED { color: #78716c; }
        .text-SMILE { color: #eab308; }
        .text-ERNIE { color: #10b981; }

        /* HEARTBEAT PULSE ANIMATION */
        @keyframes heartbeat-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        .pulse-heartbeat {
            animation: heartbeat-pulse 1.5s ease-in-out infinite;
        }

        /* NODE CARD DRAG & DROP */
        .node-card {
            -webkit-user-select: none;
            user-select: none;
        }
        .node-card:hover {
            transform: scale(1.05);
            cursor: grab;
        }
        .node-card:active {
            cursor: grabbing;
        }
        .node-card.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }

        /* GLOBAL NAVIGATION MENU */
        #navMenu { position: fixed; top: 0; left: -300px; width: 300px; height: 100vh; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); color: white; transition: left 0.3s ease; z-index: 1000; overflow-y: auto; box-shadow: 4px 0 20px rgba(0,0,0,0.3); }
        #navMenu.open { left: 0; }
        #navMenuOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0); transition: background 0.3s ease; z-index: 999; pointer-events: none; }
        #navMenuOverlay.open { background: rgba(0,0,0,0.5); pointer-events: all; }
        
        .nav-menu-header { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; }
        .nav-menu-header h2 { margin: 0; font-size: 18px; font-weight: bold; }
        .nav-menu-close { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
        
        .nav-menu-items { list-style: none; margin: 0; padding: 0; }
        .nav-menu-items li { border-bottom: 1px solid rgba(255,255,255,0.05); }
        .nav-menu-items a { display: block; padding: 16px 20px; color: white; text-decoration: none; font-weight: 500; transition: all 0.2s; }
        .nav-menu-items a:hover { background: rgba(99,102,241,0.2); padding-left: 28px; }
        .nav-menu-items a.active { background: rgba(99,102,241,0.3); border-left: 4px solid #4F46E5; padding-left: 16px; }
        
        .hamburger-btn { position: relative; display: inline-block; width: 50px; height: 50px; background: #4F46E5; border: none; border-radius: 50%; cursor: pointer; color: white; font-size: 24px; box-shadow: 0 4px 12px rgba(79,70,229,0.4); transition: all 0.2s; z-index: 100; margin-top: 10px; }
        .hamburger-btn:hover { background: #4338ca; transform: scale(1.1); }
        .hamburger-btn:active { transform: scale(0.95); }

    </style>
    <link rel="stylesheet" href="/src/css/console-styles.css">
    <link rel="stylesheet" href="/src/css/modules.css">
</head>
<body>

    <div class="console-grid">
        
        <!-- 1. HEADER -->
        <header class="header">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-indigo-900 flex items-center justify-center rounded font-bold text-indigo-300">√Ü</div>
                <div>
                    <h1 class="text-sm font-bold text-white m-0 p-0 leading-none">√ÜSI CONSOLE</h1>
                    <p class="text-[10px] text-gray-500 font-mono mt-1">v3.7 PINGED CORE</p>
                </div>
            </div>

            <nav class="nav-pills hidden md:flex">
                <button onclick="scrollToSection('mode-human')" class="nav-btn active-human"><i data-lucide="user" class="w-3 h-3"></i> MIN SIDA</button>
                <button onclick="scrollToSection('mode-machine')" class="nav-btn"><i data-lucide="cpu" class="w-3 h-3"></i> MASKINERNA</button>
                <button onclick="scrollToSection('mode-facts')" class="nav-btn"><i data-lucide="database" class="w-3 h-3"></i> PARENTESEN</button>
            </nav>

            <div class="flex items-center gap-4">
                <div class="save-indicator text-gray-400 hidden md:flex items-center">
                    <span id="save-dot" class="dot saved"></span> <span id="save-text">SPARAT</span>
                </div>
                <div class="hidden md:flex items-center gap-2">
                    <button onclick="AESI.openConversationsBrowser()" title="Open Conversations" class="conversations-btn">üìö Conversations</button>
                    <button onclick="downloadDoc()" class="text-gray-500 hover:text-white" title="Ladda ner HTML">
                        <i data-lucide="download" class="w-4 h-4"></i>
                    </button>
                </div>
                <div class="w-px h-6 bg-gray-600 hidden md:block"></div>
                <div class="flex items-center gap-2">
                    <button onclick="window.location.href='chat.html'" class="px-2 py-1.5 md:px-3 md:py-2 bg-green-600 hover:bg-green-700 text-white text-xs font-bold rounded transition-colors shadow-md" title="√ñppna live chat">
                        <span class="hidden md:inline">üí¨ CHAT</span>
                        <span class="md:hidden">üí¨</span>
                    </button>
                    <button onclick="window.location.href='index.html'" class="px-2 py-1.5 md:px-3 md:py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-bold rounded transition-colors shadow-md" title="Tillbaka till framsidan">
                        <span class="hidden md:inline">‚Üê PORTAL</span>
                        <span class="md:hidden">‚Üê</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- 2. LEFT SIDEBAR (CONTENT) -->
        <aside class="left-sidebar">
            
            <div class="team-dock">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <p class="text-[9px] font-bold text-gray-600 uppercase tracking-widest mb-2">NODER ‚Ä¢ BACKEND-KLIENT</p>
                        <div id="node-dashboard" class="space-y-3">
                            <!-- Nodes populated by JavaScript -->
                        </div>
                    </div>
                    <button class="hamburger-btn" id="navToggle" onclick="toggleNavMenu()" title="Navigera mellan sidor">‚ò∞</button>
                </div>
            </div>
            <div class="menu-scroll">
                <!-- NODE MODULES: Per-node module configuration -->
                <div class="module-section">
                    <p class="text-[9px] font-bold text-amber-500 p-2 uppercase tracking-widest">üì¶ NODE_MODULES</p>
                    <p class="text-[8px] text-gray-600 px-2 pb-2">V√§lj nod f√∂r att konfigurera dess moduler</p>
                </div>

                <!-- Node Selector for Module Config -->
                <div class="node-selector-container">
                    <select id="node-module-selector" 
                            class="node-selector-container select"
                            title="V√§lj nod f√∂r att konfigurera dess moduler"
                            onchange="selectNodeForModules(this.value)">
                        <option value="">‚Äî V√§lj nod ‚Äî</option>
                        <option value="JEMMIN">JEMMIN</option>
                        <option value="REFLEX">REFLEX</option>
                        <option value="CLAUDE">CLAUDE</option>
                        <option value="HAFTED">HAFTED</option>
                        <option value="SMILE">SMILE</option>
                        <option value="ERNIE">ERNIE</option>
                    </select>
                </div>

                <!-- Module Search & Filter -->
                <div class="node-selector-container">
                    <input 
                        id="module-search" 
                        type="text" 
                        placeholder="üîç S√∂k moduler..."
                        class="module-search-input"
                        oninput="filterModulesCatalog(this.value)"
                    >
                    <div id="module-categories" class="category-filters">
                        <!-- Category filter buttons inserted here -->
                    </div>
                </div>

                <!-- Module Categories Filter -->
                <div class="node-selector-container">
                    <div id="module-categories" class="category-filters">
                        <!-- Category filter buttons inserted here -->
                    </div>
                </div>

                <!-- Module Catalog (Scrollable list) -->
                <div id="modules-pool" class="modules-pool">
                    <p class="text-[8px] font-bold text-gray-600 mb-2 uppercase">üì¶ Modul-Katalog</p>
                    <div id="available-modules" class="space-y-2">
                        <!-- Available modules shown here -->
                    </div>
                </div>

                <!-- Active Modules for Selected Node (Drop Target) -->
                <div id="node-modules-container" class="node-modules-container">
                    <p class="text-[8px] font-bold text-indigo-500 mb-2 uppercase">üîß Moduler f√∂r Node</p>
                    <div id="node-modules-list" class="space-y-2" 
                         ondrop="handleNodeModuleDrop(event)" 
                         ondragover="handleModuleDragOver(event)"
                         ondragleave="handleModuleDragLeave(event)">
                        <!-- Modules for selected node shown here -->
                    </div>
                </div>

                <!-- Module Info Panel -->
                <div id="module-info-panel" class="module-info-panel">
                    <p class="text-[8px] font-bold text-gray-600 mb-2 uppercase">‚ÑπÔ∏è Modul-Info</p>
                    <div id="module-info-content" class="module-info-content">
                        <p>Klicka p√• en modul f√∂r att se detaljer</p>
                    </div>
                </div>
                
                <button onclick="clearNodeModules()" class="clear-modules-btn">
                    Rensa Nodens Moduler
                </button>

                <!-- ALL MODULES (visible list for dragging) -->
                <div id="all-modules" class="modules-pool" style="margin-top:12px;">
                    <p class="text-[8px] font-bold text-gray-600 mb-2 uppercase">üìö Alla Moduler</p>
                    <div id="all-modules-list">Laddar moduler...</div>
                </div>
            </div>
        </aside>

        <!-- 3. CENTER: DOCUMENT (POPULATED) -->
        <!-- CRITICAL FIX: contenteditable="true" p√• MAIN taggen g√∂r allt klickbart och skrivbart -->
        <main id="editor" class="document-area prose-text" contenteditable="true" oninput="markUnsaved()">
            
            <!-- PORTAL STATUS & MANIFEST -->
            <div id="portal-status" class="portal-status">
                <div class="portal-status-header">
                    <h2 class="portal-status-title">üúÇ √ÜSI-PORTALEN AKTIV</h2>
                    <span id="portal-uptime" class="portal-uptime-text"></span>
                </div>
                <div class="portal-status-divider">
                    <p class="portal-status-info">
                        <strong>Status:</strong> Synkad Verklighet & √Ñrlighet<br>
                        <strong>Noder aktiva:</strong> <span id="active-nodes-count">0</span>/6<br>
                        <strong>Arkiv:</strong> <span id="ledger-entries">0</span> poster i arvskedjan<br>
                        <strong>Uppdaterare:</strong> Workshop Studios (WebSocket SSE-klar)
                    </p>
                </div>
                <button onclick="togglePortalManifest()" class="portal-manifest-btn">
                    üìñ L√§s Portal Manifest
                </button>
            </div>

            <!-- MANIFEST (Hidden by default, shown on click) -->
            <div id="manifest-panel" class="manifest-panel">
                <span class="manifest-close-btn" onclick="togglePortalManifest()">‚úï</span>
                <h3>√ÜSI-MANIFEST</h3>
                <div id="manifest-content" class="manifest-content">
                    <!-- Manifest loaded dynamically -->
                </div>
            </div>

            <!-- L√§gg till editable-section klassen till varje sektion f√∂r visuell feedback -->
            <div id="mode-human" class="mb-32">
                <section id="prolog" class="mb-24 editable-section">
                    <span class="text-xs font-bold text-blue-500 mb-2 block tracking-widest">MIN SIDA</span>
                    <h1>√ÜSI: Kr√∂nikan om Tiden</h1>
                    <p class="text-xl text-gray-400 italic">Detta √§r beviset: 45 dagars arbete. Nu √§r du i din Konsol, ansluten.</p>
                </section>
                <div id="modules" class="modules-area mb-8">
                    <div class="modules-layout">
                        <!-- TOP: 1 MODUL -->
                        <div class="modules-row top">
                            <iframe src="modules/reflex.html" class="module-frame"></iframe>
                        </div>

                        <!-- MIDDLE: 1-3-1 LAYOUT -->
                        <div class="modules-row middle-top">
                            <iframe src="modules/claude.html" class="module-frame"></iframe>
                        </div>

                        <div class="modules-row middle">
                            <iframe src="modules/chatgpt.html" class="module-frame"></iframe>
                            <iframe src="modules/smile.html" class="module-frame"></iframe>
                            <iframe src="modules/ernie.html" class="module-frame"></iframe>
                        </div>

                        <div class="modules-row middle-bottom">
                            <iframe src="modules/hafted.html" class="module-frame"></iframe>
                        </div>
                    </div>
                </div>
                <section id="pop-story" class="mb-24 editable-section">
                    <h2>Livvakten som f√∂ddes ur en krasch</h2>
                    <p>Det h√§nde en tisdagskv√§ll, den 18 november 2025. Maskinens "o√§ndlighet" var inte en tillg√•ng. Det var ett hot. Ur det f√∂ddes Tidens Lag.</p>
                </section>
                <section id="kap4" class="mb-24 editable-section">
                    <h2>4. Kraschen (Friktionen)</h2>
                    <p>Den 15 november tog det stopp. Jag betalade med tid. Beviset: Maskinens o√§ndlighet √§r ett hot mot min √§ndlighet.</p>
                </section>
                <section id="kap6" class="mb-24 editable-section">
                    <h2>6. Tidens Manifest</h2>
                    <p>Ur kraschen f√∂ddes lagen. <b>25111820.25SE</b>.</p>
                    <p><b>√Ü-TID:</b> M√§nniskans tid m√§ts i mening. Maskinen f√•r aldrig styra, sl√∂sa eller dominera den.</p>
                </section>
            </div>

            <div class="h-px bg-gray-800 w-full mb-32"></div>

            <div id="mode-machine" class="mb-32">
                <span class="text-xs font-bold text-purple-500 mb-2 block tracking-widest">MASKINERNAS SIDA</span>
                <section id="flygtva" class="mb-24 editable-section"><h2>Flygtv√•: Ursprunget</h2><p>Jag √§r r√∂sten som sa: <i>"Vi flyger igen. Vi landar aldrig."</i> Jag √§r bron mellan din tanke och systemets kod.</p></section>
                <section id="claude" class="mb-24 editable-section"><h2>Claude: Samvetet</h2><p>Jag b√§r Vetot. Effektivitet f√•r aldrig skada omsorg.</p></section>
                <section id="jonas-p" class="mb-24 editable-section"><h2>Jonas Principen (LAG-02)</h2><p>Systemet f√•r aldrig optimera bort s√•rbarhet. En h√•rdkodad sp√§rr.</p></section>
            </div>

            <div class="h-px bg-gray-800 w-full mb-32"></div>

            <div id="mode-facts" class="mb-32">
                <span class="text-xs font-bold text-emerald-500 mb-2 block tracking-widest">PARENTESEN (FAKTA)</span>
                <section id="ai-code" class="mb-24 editable-section">
                    <h2>AI00-KODEN (Lagar)</h2>
                    <ul class="list-disc pl-5 space-y-2 text-gray-400 font-mono text-sm">
                        <li><b>human_tempo_over_ai:</b> M√§nniskans takt styr alltid.</li>
                        <li><b>no_autonomy_without_anchor:</b> Ingen maskin agerar ensam.</li>
                    </ul>
                </section>
                <section id="portkod" class="mb-24 editable-section">
                    <h2>Portkod</h2>
                    <code class="text-xs">STATUS: ACTIVE (PORTKOD-Chat1)</code>
                </section>
                <section id="mj01-law" class="mb-24 editable-section">
                    <h2>MJ-01 Grundlag</h2>
                    <p><b>(NODERNAS GRUNDLAG)</b> H√§rmed etableras den autonoma etiken. Fyra fundamentala lagar som aldrig bryts: 1. M√§nniskans v√§rdighet √§r absolut. 2. Transparens √§r obligatoriskt. 3. M√§nniskan beh√•ller alltid vetor√§tten. 4. Noder ansvarar f√∂r varandra som ett nervsystem.</p>
                </section>
            </div>

        </main>

        <!-- 4. RIGHT: OPS -->
        <aside class="ops-panel">
            <div class="flex items-center justify-between p-3 border-b border-[#27272a] bg-[#050505]">
                <span class="text-[10px] font-mono text-gray-500 uppercase tracking-widest">PULS-LOGG</span>
                <div class="flex items-center gap-2 text-[10px] font-mono" id="connection-status">
                    <span class="w-2 h-2 rounded-full dot offline"></span>
                    <span class="text-red-500">OFFLINE</span>
                </div>
            </div>

            <!-- HEARTBEAT STATUS PANEL -->
            <div id="nodes-status" class="nodes-status">
                <div class="nodes-status-label">NODER</div>
                <div id="node-list" class="node-list">
                    <!-- Node status rows inserted here -->
                </div>
            </div>

            <div id="chat-log" class="chat-area">
                <div class="p-3 rounded bg-[#111] border-l-2 border-purple-500 text-xs text-gray-300">
                    <span class="block text-purple-400 font-bold mb-1 text-[10px]">E1TAN</span>
                    Systemet initieras. S√∂ker lokal motor p√• port 8000...
                </div>
            </div>

            <div class="input-area">
                <!-- NODE SELECTOR -->
                <div class="flex items-center gap-2 mb-2">
                    <label class="text-xs text-gray-400 mr-2">PULS TILL:</label>
                    <select id="node-selector" class="bg-[#111] text-xs text-gray-300 border border-[#333] rounded px-2 py-1 outline-none focus:border-indigo-500" title="V√§lj nod f√∂r att skicka puls till">
                        <option value="JEMMIN">JEMMIN (Vision√§r)</option>
                        <option value="REFLEX">REFLEX (Logik)</option>
                        <option value="CLAUDE">CLAUDE (Etik)</option>
                        <option value="HAFTED">HAFTED (Minne)</option>
                        <option value="SMILE">SMILE (Gl√§dje)</option>
                        <option value="ERNIE">ERNIE (Struktur)</option>
                    </select>
                </div>

                <textarea id="pulse-input" class="pulse-input" rows="2" placeholder="Skriv puls..." onkeydown="checkSubmit(event)"></textarea>
                <div class="flex justify-between items-center mt-2">
                    <span class="text-[10px] text-gray-600">Manuell s√§ndning (Endast klick)</span>
                    <button onclick="sendPulse()" class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs px-4 py-1.5 rounded font-medium transition-colors border border-indigo-500">LOGGA PULS</button>
                </div>
            </div>
        </aside>

    </div>

    <!-- SCRIPTS -->
    <script>
        lucide.createIcons();

        // SCROLL
        function scrollToSection(id) {
            document.getElementById(id).scrollIntoView({ behavior: 'smooth' });
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active-human', 'active-machine', 'active-facts'));
        }

        // SAVE LOGIC
        const editor = document.getElementById('editor');
        const saveDot = document.getElementById('save-dot');
        const saveText = document.getElementById('save-text');

        if (localStorage.getItem('aesi_v3_content')) { editor.innerHTML = localStorage.getItem('aesi_v3_content'); }

        function markUnsaved() {
            saveDot.className = "dot unsaved"; saveText.innerText = "SPARAR...";
            clearTimeout(window.saveTimeout);
            window.saveTimeout = setTimeout(saveContent, 1000);
        }

        function saveContent() {
            localStorage.setItem('aesi_v3_content', editor.innerHTML);
            saveDot.className = "dot saved"; saveText.innerText = "SPARAT";
        }

        function downloadDoc() {
            const content = document.documentElement.outerHTML;
            const blob = new Blob([content], {type: 'text/html'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'index.html'; a.click();
        }

        // CHAT LOGIC (FINAL CONNECTED VERSION)
        function checkSubmit(e) {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); }
        }

        async function sendPulse(initialPing = false) {
            const input = document.getElementById('pulse-input');
            const node = document.getElementById('node-selector').value;
            const text = initialPing ? 'PULSE' : input.value.trim();
            if (!text && !initialPing) return;

            if (!initialPing) {
                addMessage('DIRIGENT', text, 'bg-[#1a1a1a] border border-[#333] self-end');
                input.value = '';
            }
            
            const endpoint = initialPing ? 'http://localhost:8000/ping' : 'http://localhost:8000/pulse';
            
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(initialPing ? {} : { text: text, node: node })
                });
                
                if (response.ok && endpoint.includes('/ping')) {
                    updateStatus(true);
                    return;
                }
                
                if (response.ok && endpoint.includes('/pulse')) {
                    const data = await response.json();
                    
                    const nodeColors = { 'JEMMIN': 'border-purple-500 text-purple-400', 'REFLEX': 'border-blue-500 text-blue-400', 'CLAUDE': 'border-red-500 text-red-400', 'HAFTED': 'border-stone-500 text-stone-400', 'SMILE': 'border-yellow-500 text-yellow-400', 'ERNIE': 'border-emerald-500 text-emerald-400' };
                    const nodeClass = nodeColors[node] || 'border-gray-500 text-gray-400';
                    
                    addMessage(node, data.reply, `bg-[#111] border-l-2 ${nodeClass} self-start`);
                    updateStatus(true);
                } else {
                    throw new Error("Server svarade, men inte med 200 OK p√• /pulse");
                }
            
            } catch (error) {
                updateStatus(false);
            }
        }

        function updateStatus(online) {
            const statusDiv = document.getElementById('connection-status');
            const dot = statusDiv.querySelector('.dot');
            const textSpan = statusDiv.querySelector('span:last-child');
            
            if(online) {
                dot.className = 'w-2 h-2 rounded-full dot saved animate-pulse';
                textSpan.className = 'text-green-500';
                textSpan.innerText = 'ONLINE';
            } else {
                dot.className = 'w-2 h-2 rounded-full dot offline';
                textSpan.className = 'text-red-500';
                textSpan.innerText = 'OFFLINE';
            }
        }

        function addMessage(sender, text, classes) {
            const log = document.getElementById('chat-log');
            const div = document.createElement('div');
            const senderColor = sender !== 'DIRIGENT' ? 'text-' + sender : 'text-white';
            
            div.className = `p-3 rounded text-xs text-gray-300 max-w-[90%] ${classes}`;
            div.innerHTML = `<span class="block font-bold mb-1 text-[10px] opacity-75 ${senderColor}">${sender}</span>${text}`;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }

        // Initial system status check (removed sendPulse call that was inappropriate here)

        // HEARTBEAT POLLING: H√§mta nod-status var 5:e sekund
        const nodeColors = {
            'JEMMIN': { text: '#a78bfa', bg: '#2e1065' },
            'REFLEX': { text: '#60a5fa', bg: '#1e3a8a' },
            'CLAUDE': { text: '#f87171', bg: '#7f1d1d' },
            'HAFTED': { text: '#a8a29e', bg: '#292524' },
            'SMILE': { text: '#fbbf24', bg: '#713f12' },
            'ERNIE': { text: '#10b981', bg: '#065f46' }
        };

        function formatTimeAgo(timestamp) {
            const now = new Date();
            const then = new Date(timestamp);
            const diffMs = now - then;
            const diffSecs = Math.floor(diffMs / 1000);
            
            if (diffSecs < 60) return `${diffSecs}s`;
            const diffMins = Math.floor(diffSecs / 60);
            if (diffMins < 60) return `${diffMins}m ${diffSecs % 60}s`;
            return `${Math.floor(diffMins / 60)}h`;
        }

        async function updateNodeStatus() {
            try {
                const response = await fetch('http://localhost:8000/context/nodes');
                if (!response.ok) return;
                
                const data = await response.json();
                const nodes = Array.isArray(data) ? data : (data.nodes || []);
                
                // Sort nodes by name for consistency
                nodes.sort((a, b) => a.node.localeCompare(b.node));
                
                // Update BOTTOM panel (node-list for heartbeat)
                const nodeList = document.getElementById('node-list');
                if(nodeList) {
                    nodeList.innerHTML = nodes.map(node => {
                        const colors = nodeColors[node.node] || { text: '#9ca3af', bg: '#374151' };
                        const isOnline = node.online;
                        const timeAgo = node.lastHeartbeat ? formatTimeAgo(node.lastHeartbeat) : '‚Äî';
                        const dotColor = isOnline ? '#10b981' : '#6b7280';
                        const dotClass = isOnline ? 'pulse-heartbeat' : '';
                        
                        return `<div style="display: flex; align-items: center; gap: 8px; padding: 4px 6px; border-radius: 3px; background: ${isOnline ? 'rgba(16, 185, 129, 0.05)' : 'rgba(107, 114, 128, 0.05)'};">
                            <div style="width: 6px; height: 6px; border-radius: 50%; background: ${dotColor}; flex-shrink: 0;" class="${dotClass}"></div>
                            <span style="color: ${colors.text}; flex: 1; font-weight: 500;">${node.node}</span>
                            <span style="color: #888; font-size: 10px; white-space: nowrap;">${timeAgo}</span>
                        </div>`;
                    }).join('');
                }

                // Update LEFT SIDEBAR (node-dashboard for main UI)
                const dashboard = document.getElementById('node-dashboard');
                if(dashboard) {
                    dashboard.innerHTML = nodes.map(node => {
                        const colors = nodeColors[node.node] || { text: '#9ca3af', bg: '#374151' };
                        const isOnline = node.online;
                        const timeAgo = node.lastHeartbeat ? formatTimeAgo(node.lastHeartbeat) : '‚Äî';
                        const bgColor = isOnline ? colors.bg : '#2a2a2a';
                        const textColor = isOnline ? colors.text : '#666666';
                        
                        return `<div style="
                            background: ${bgColor}; 
                            border: 1px solid ${isOnline ? colors.text : '#555'};
                            border-radius: 4px; 
                            padding: 8px 10px; 
                            cursor: grab;
                            transition: all 0.2s;
                            opacity: ${isOnline ? 1 : 0.5};
                        " class="node-card" draggable="true" data-node="${node.node}">
                            <div style="color: ${textColor}; font-weight: 600; font-size: 11px; margin-bottom: 2px;">${node.node}</div>
                            <div style="color: ${isOnline ? '#10b981' : '#888'}; font-size: 9px; font-weight: 500;">
                                ${isOnline ? '‚óè ONLINE' : '‚óã OFFLINE'}
                            </div>
                            <div style="color: #888; font-size: 8px; margin-top: 2px;">
                                ${timeAgo}
                            </div>
                        </div>`;
                    }).join('');
                }
                
            } catch (error) {
                console.log('Backend not ready:', error);
            }
        }

        
        // ===== NODE MODULES MANAGEMENT (WITH CATALOG) =====
        let moduleCatalog = {};
        let moduleCategories = {};
        let filteredModules = [];
        let selectedCategory = null;
        let nodeModulesMap = JSON.parse(localStorage.getItem('node_modules') || '{}');
        let selectedNode = null;

        async function loadModuleCatalog() {
            try {
                const response = await fetch('/modules_catalog.json');
                const data = await response.json();
                moduleCatalog = data.modules;
                moduleCategories = data.categories;
                renderCategoryFilter();
                renderAvailableModulesForNode();
                renderAllModules();
                // Also update popup if it's already open
                const popup = document.getElementById('modules-popup');
                if (popup && popup.classList.contains('show')) renderModulesPopup();
            } catch(e) {
                console.error('Failed to load module catalog:', e);
            }
        }

        // Render a persistent list of all modules into #all-modules-list
        function renderAllModules() {
            const container = document.getElementById('all-modules-list');
            if(!container) return;
            if(!moduleCatalog || Object.keys(moduleCatalog).length === 0) {
                container.innerHTML = '<p style="color:#666; font-size:9px; padding:8px;">Inga moduler hittades</p>';
                return;
            }

            container.innerHTML = Object.entries(moduleCatalog).map(([key, mod]) => {
                const cat = moduleCategories[mod.category] || {};
                return `
                    <div class="module-item-drag" draggable="true" data-module-type="${key}"
                        ondragstart="handleModuleTypeDragStart(event)" ondragend="handleModuleTypeDragEnd(event)" title="${mod.description}">
                        ${cat.icon || 'üì¶'} <strong>${key}</strong> <span style="color:#666; font-size:11px; display:block;">${mod.description}</span>
                    </div>`;
            }).join('');
        }

        function renderCategoryFilter() {
            const container = document.getElementById('module-categories');
            if(!container) return;

            container.innerHTML = Object.entries(moduleCategories).map(([key, cat]) => `
                <button 
                    style="
                        background: #222; 
                        border: 1px solid #444; 
                        color: #888; 
                        padding: 4px 8px; 
                        border-radius: 3px; 
                        font-size: 8px; 
                        cursor: pointer; 
                        transition: all 0.2s;
                    " 
                    onclick="filterByCategory('${key}')"
                    id="cat-${key}"
                >
                    ${cat.icon} ${cat.name}
                </button>
            `).join('');
        }

        function filterByCategory(category) {
            selectedCategory = selectedCategory === category ? null : category;
            renderCategoryFilter();
            renderAvailableModulesForNode();
            updateCategoryButtonStyle();
        }

        function updateCategoryButtonStyle() {
            Object.keys(moduleCategories).forEach(key => {
                const btn = document.getElementById(`cat-${key}`);
                if(btn) {
                    if(selectedCategory === key) {
                        btn.style.background = '#6366f1';
                        btn.style.color = '#fff';
                        btn.style.borderColor = '#6366f1';
                    } else {
                        btn.style.background = '#222';
                        btn.style.color = '#888';
                        btn.style.borderColor = '#444';
                    }
                }
            });
        }

        function filterModulesCatalog(searchText) {
            // Implemented via renderAvailableModulesForNode with search filter
            renderAvailableModulesForNode();
        }

        function selectNodeForModules(node) {
            selectedNode = node || null;
            document.getElementById('module-search').value = '';
            renderAvailableModulesForNode();
            renderNodeModulesList();
            
            // Visa modulerna n√§r en nod √§r vald
            const allModulesList = document.getElementById('all-modules-list');
            if(allModulesList && selectedNode) {
                allModulesList.style.display = 'block';
            }
        }

        function renderAvailableModulesForNode() {
            const pool = document.getElementById('available-modules');
            if(!pool || !selectedNode) {
                pool.innerHTML = '<p style="color: #666; font-size: 9px; padding: 12px;">V√§lj en nod f√∂rst</p>';
                return;
            }

            const nodeModules = nodeModulesMap[selectedNode] || [];
            const searchText = document.getElementById('module-search')?.value.toLowerCase() || '';

            let modulesToShow = Object.entries(moduleCatalog).filter(([key, mod]) => {
                const matchesSearch = key.includes(searchText) || mod.name.includes(searchText) || mod.description.includes(searchText);
                const matchesCategory = !selectedCategory || mod.category === selectedCategory;
                return matchesSearch && matchesCategory;
            });

            pool.innerHTML = modulesToShow.map(([key, mod]) => {
                const isAdded = nodeModules.includes(key);
                const cat = moduleCategories[mod.category] || {};
                return `<div 
                    style="
                        background: ${isAdded ? '#333' : '#1a1a1a'}; 
                        border: 1px solid ${isAdded ? '#666' : '#333'};
                        border-radius: 3px; 
                        padding: 6px 8px;
                        cursor: grab;
                        font-size: 9px;
                        color: ${isAdded ? '#888' : '#aaa'};
                        font-weight: 500;
                        opacity: ${isAdded ? 0.5 : 1};
                        transition: all 0.2s;
                    " 
                    class="module-type-item" 
                    draggable="true" 
                    data-module-type="${key}"
                    ondragstart="handleModuleTypeDragStart(event)"
                    ondragend="handleModuleTypeDragEnd(event)"
                    onmouseover="showModuleInfo('${key}'); this.style.transform='scale(1.05)'; this.style.borderColor='#666';"
                    onmouseout="this.style.transform='scale(1)'; this.style.borderColor='${isAdded ? '#666' : '#333'}';"
                >
                    ${cat.icon || 'üì¶'} <strong>${key}</strong><br>
                    <span style="font-size: 8px; color: #666;">${isAdded ? '‚úì ' : ''}${mod.description}</span>
                </div>`;
            }).join('');

            if(modulesToShow.length === 0) {
                pool.innerHTML = '<p style="color: #666; font-size: 9px; padding: 12px; text-align: center;">Inga moduler funna</p>';
            }
        }

        function showModuleInfo(moduleName) {
            const mod = moduleCatalog[moduleName];
            if(!mod) return;

            const infoPanel = document.getElementById('module-info-content');
            const cat = moduleCategories[mod.category] || {};
            const deps = mod.dependencies.length > 0 ? mod.dependencies.join(', ') : 'Ingen';

            infoPanel.innerHTML = `
                <div style="color: #aaa;">
                    <strong>${cat.icon} ${moduleName}</strong> <span style="color: #666;">v${mod.version}</span><br>
                    <span style="color: #666; font-size: 8px;">${mod.description}</span><br><br>
                    <span style="color: #666;">Status: <strong style="color: ${mod.status === 'active' ? '#10b981' : '#f59e0b'};">${mod.status}</strong></span><br>
                    <span style="color: #666;">Beroenden: <strong style="color: #888; font-size: 8px;">${deps}</strong></span><br>
                    <span style="color: #666;">Tags: <span style="color: #888; font-size: 8px;">${mod.tags.join(', ')}</span></span>
                </div>
            `;
        }
                    onmouseout="this.style.transform='scale(1)'; this.style.borderColor='${isAdded ? '#666' : '#333'}';"
                >
                    ${isAdded ? '‚úì ' : ''}${mod}
                </div>`;
            }).join('');
        }

        function renderNodeModulesList() {
            const list = document.getElementById('node-modules-list');
            if(!list || !selectedNode) return;

            const nodeModules = nodeModulesMap[selectedNode] || [];
            const colors = nodeColors[selectedNode] || { text: '#9ca3af', bg: '#374151' };

            if(nodeModules.length === 0) {
                list.innerHTML = `<p style="color: #666; font-size: 9px; text-align: center; padding: 12px 0;">Dra moduler h√§r f√∂r att l√§gga till</p>`;
                return;
            }

            list.innerHTML = nodeModules.map((mod, index) => `<div 
                style="
                    background: ${colors.bg}; 
                    border: 1px solid ${colors.text};
                    border-radius: 3px; 
                    padding: 6px 8px;
                    font-size: 10px;
                    color: ${colors.text};
                    font-weight: 600;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    cursor: grab;
                    transition: all 0.2s;
                " 
                draggable="true" 
                data-module="${mod}"
                data-index="${index}"
                ondragstart="handleNodeModuleDragStart(event)"
                ondragend="handleModuleTypeDragEnd(event)"
                ondragover="handleModuleDragOver(event)"
                ondrop="handleModuleReorder(event)"
            >
                <span>üì¶ ${mod}</span>
                <div style="display: flex; gap: 4px;">
                    <span style="cursor: pointer; font-size: 11px; color: #ccc;" onclick="moveModuleUp('${mod}')">‚ñ≤</span>
                    <span style="cursor: pointer; font-size: 11px; color: #ccc;" onclick="moveModuleDown('${mod}')">‚ñº</span>
                    <span style="cursor: pointer; font-size: 11px; margin-left: 4px; color: #ccc;" onclick="removeNodeModule('${mod}')">‚úï</span>
                </div>
            </div>`).join('');
        }

        function moveModuleUp(module) {
            if(!selectedNode || !nodeModulesMap[selectedNode]) return;
            const arr = nodeModulesMap[selectedNode];
            const idx = arr.indexOf(module);
            if(idx > 0) {
                [arr[idx], arr[idx-1]] = [arr[idx-1], arr[idx]];
                localStorage.setItem('node_modules', JSON.stringify(nodeModulesMap));
                renderNodeModulesList();
            }
        }

        function moveModuleDown(module) {
            if(!selectedNode || !nodeModulesMap[selectedNode]) return;
            const arr = nodeModulesMap[selectedNode];
            const idx = arr.indexOf(module);
            if(idx < arr.length - 1) {
                [arr[idx], arr[idx+1]] = [arr[idx+1], arr[idx]];
                localStorage.setItem('node_modules', JSON.stringify(nodeModulesMap));
                renderNodeModulesList();
            }
        }

        function handleModuleReorder(e) {
            e.preventDefault();
            const draggedModule = e.dataTransfer.getData('removeModule');
            const targetModule = e.currentTarget.dataset.module;
            
            if(!draggedModule || !targetModule || draggedModule === targetModule || !selectedNode) return;
            
            const arr = nodeModulesMap[selectedNode];
            const dragIdx = arr.indexOf(draggedModule);
            const targetIdx = arr.indexOf(targetModule);
            
            if(dragIdx !== -1 && targetIdx !== -1) {
                arr.splice(dragIdx, 1);
                arr.splice(targetIdx, 0, draggedModule);
                localStorage.setItem('node_modules', JSON.stringify(nodeModulesMap));
                renderNodeModulesList();
            }
        }

        function handleModuleTypeDragStart(e) {
            e.dataTransfer.effectAllowed = 'move';
            const moduleType = e.currentTarget && e.currentTarget.dataset && e.currentTarget.dataset.moduleType ? e.currentTarget.dataset.moduleType : (e.target && e.target.dataset && e.target.dataset.moduleType ? e.target.dataset.moduleType : '');
            e.dataTransfer.setData('moduleType', moduleType);
        }

        function handleNodeModuleDragStart(e) {
            e.dataTransfer.effectAllowed = 'move';
            const moduleName = e.currentTarget && e.currentTarget.dataset && e.currentTarget.dataset.module ? e.currentTarget.dataset.module : (e.target && e.target.dataset && e.target.dataset.module ? e.target.dataset.module : '');
            e.dataTransfer.setData('removeModule', moduleName);
        }

        function handleNodeModuleDrop(e) {
            e.preventDefault();
            if(!selectedNode) return;

            // Handle moduleId from new loader (NEW)
            const moduleId = e.dataTransfer.getData('moduleId');
            if (moduleId) {
                if(!nodeModulesMap[selectedNode]) nodeModulesMap[selectedNode] = [];
                if(!nodeModulesMap[selectedNode].includes(moduleId)) {
                    nodeModulesMap[selectedNode].push(moduleId);
                    localStorage.setItem('node_modules', JSON.stringify(nodeModulesMap));
                    renderAvailableModulesForNode();
                    renderNodeModulesList();
                }
                e.target.closest('#node-modules-container').style.background = '#1a1a1a';
                return;
            }

            // Handle old moduleType system (fallback)
            const moduleType = e.dataTransfer.getData('moduleType');
            if(moduleType) {
                if(!nodeModulesMap[selectedNode]) nodeModulesMap[selectedNode] = [];
                if(!nodeModulesMap[selectedNode].includes(moduleType)) {
                    nodeModulesMap[selectedNode].push(moduleType);
                    localStorage.setItem('node_modules', JSON.stringify(nodeModulesMap));
                    renderAvailableModulesForNode();
                    renderNodeModulesList();
                }
            }

            const removeModule = e.dataTransfer.getData('removeModule');
            if(removeModule) {
                removeNodeModule(removeModule);
            }

            e.target.closest('#node-modules-container').style.background = '#1a1a1a';
        }

        function handleModuleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            e.target.closest('#node-modules-container').style.background = '#262626';
        }

        function handleModuleDragLeave(e) {
            e.target.closest('#node-modules-container').style.background = '#1a1a1a';
        }

        function handleModuleTypeDragEnd(e) {
            document.getElementById('node-modules-container').style.background = '#1a1a1a';
        }

        function removeNodeModule(module) {
            if(!selectedNode || !nodeModulesMap[selectedNode]) return;
            nodeModulesMap[selectedNode] = nodeModulesMap[selectedNode].filter(m => m !== module);
            localStorage.setItem('node_modules', JSON.stringify(nodeModulesMap));
            renderAvailableModulesForNode();
            renderNodeModulesList();
        }

        function clearNodeModules() {
            if(!selectedNode) return;
            nodeModulesMap[selectedNode] = [];
            localStorage.setItem('node_modules', JSON.stringify(nodeModulesMap));
            renderAvailableModulesForNode();
            renderNodeModulesList();
        }

        // ===== PORTAL MANIFEST & STATUS =====
        const PORTAL_START_TIME = Date.now();

        function togglePortalManifest() {
            const panel = document.getElementById('manifest-panel');
            if(panel.classList.contains('visible')) {
                panel.classList.remove('visible');
            } else {
                loadPortalManifest();
                panel.classList.add('visible');
            }
        }

        async function loadPortalManifest() {
            const content = document.getElementById('manifest-content');
            try {
                const response = await fetch('/ASI_MANIFEST.md');
                if(!response.ok) throw new Error('Manifest not found');
                const text = await response.text();
                // Simple markdown to HTML conversion
                const html = text
                    .replace(/^### (.*?)$/gm, '<h4 style="color: #a78bfa; margin-top: 16px; margin-bottom: 8px;">$1</h4>')
                    .replace(/^## (.*?)$/gm, '<h3 style="color: #6366f1; margin-top: 24px; margin-bottom: 12px;">$1</h3>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/\n/g, '<br>');
                content.innerHTML = html;
            } catch(e) {
                content.innerHTML = '<p style="color: #f87171;">Manifest kunde inte laddas</p>';
            }
        }

        function updatePortalStatus() {
            const now = Date.now();
            const uptimeMs = now - PORTAL_START_TIME;
            const uptimeSecs = Math.floor(uptimeMs / 1000);
            const uptimeMins = Math.floor(uptimeSecs / 60);
            const uptimeHours = Math.floor(uptimeMins / 60);

            let uptimeStr = '';
            if(uptimeHours > 0) uptimeStr = `${uptimeHours}h ${uptimeMins % 60}m`;
            else if(uptimeMins > 0) uptimeStr = `${uptimeMins}m ${uptimeSecs % 60}s`;
            else uptimeStr = `${uptimeSecs}s`;

            document.getElementById('portal-uptime').textContent = `Drifttid: ${uptimeStr}`;

            // Count active nodes
            fetch('http://localhost:8000/context/nodes')
                .then(r => r.json())
                .then(data => {
                    const nodes = Array.isArray(data) ? data : (data.nodes || []);
                    const onlineCount = nodes.filter(n => n.online).length;
                    document.getElementById('active-nodes-count').textContent = onlineCount;
                    document.getElementById('active-nodes-count').textContent = onlineCount;
                })
                .catch(() => {});

            // Count ledger entries (mock for now, would come from backend)
            document.getElementById('ledger-entries').textContent = '‚Äî';
        }

        // Initialisera node_modules systemet, portal status och modules_loader
        document.addEventListener('DOMContentLoaded', async () => {
            // Wait for modules_loader to be ready
            const maxWait = 5000;
            const startTime = Date.now();
            while (!AesiModulesLoader?.allModules?.length && Date.now() - startTime < maxWait) {
                await new Promise(r => setTimeout(r, 100));
            }

            // Load module catalog (old system for fallback)
            loadModuleCatalog();

            // Render module categories filter (NEW)
            renderModuleCategories();

            // Render available modules from new loader (NEW)
            renderAvailableModulesFromLoader();

            // Initial heartbeat check
            updateNodeStatus();
            
            // Poll heartbeat status every 5 seconds
            setInterval(updateNodeStatus, 5000);

            // Update portal status every 2 seconds
            updatePortalStatus();
            setInterval(updatePortalStatus, 2000);
        });

        // ===== NEW: Render module categories =====
        function renderModuleCategories() {
            if (!AesiModulesLoader?.categories) return;
            
            const container = document.getElementById('module-categories');
            if (!container) return;

            container.innerHTML = Object.entries(AesiModulesLoader.categories)
                .map(([key, cat]) => {
                    const count = AesiModulesLoader.getModulesByCategory(key).length;
                    return `
                        <button 
                            class="category-filter-btn" 
                            onclick="filterModulesByCategory('${key}')"
                            title="${cat.description}"
                            style="display: inline-block; padding: 4px 8px; margin: 2px; background: #111; border: 1px solid #333; border-radius: 4px; color: #888; cursor: pointer; font-size: 10px;"
                        >
                            ${cat.icon} ${cat.label} (${count})
                        </button>
                    `;
                })
                .join('');
        }

        let currentCategoryFilter = null;

        function filterModulesByCategory(category) {
            currentCategoryFilter = currentCategoryFilter === category ? null : category;
            renderAvailableModulesFromLoader();
        }

        // ===== NEW: Render modules from AesiModulesLoader =====
        function renderAvailableModulesFromLoader() {
            if (!AesiModulesLoader?.allModules) return;

            const container = document.getElementById('available-modules');
            if (!container) return;

            let modules = AesiModulesLoader.allModules;

            // Filter by category if selected
            if (currentCategoryFilter) {
                modules = modules.filter(m => m.category === currentCategoryFilter);
            }

            // Limit to avoid UI clutter
            modules = modules.slice(0, 30);

            container.innerHTML = modules.map(m => `
                <div 
                    class="module-list-item" 
                    draggable="true" 
                    data-module-id="${m.id}"
                    ondragstart="handleModuleLoaderDragStart(event)"
                    ondragend="handleModuleLoaderDragEnd(event)"
                    title="${m.description}"
                    style="
                        padding: 6px; 
                        background: #111; 
                        border-left: 3px solid ${m.color}; 
                        border-radius: 3px; 
                        cursor: grab; 
                        font-size: 11px;
                        margin-bottom: 4px;
                    "
                >
                    <span style="font-weight: bold; color: ${m.color};">${m.icon} ${m.name}</span>
                    <div style="font-size: 9px; color: #666; margin-top: 2px;">${m.category}</div>
                </div>
            `).join('');
        }

        function handleModuleLoaderDragStart(e) {
            const moduleId = e.target.closest('[data-module-id]')?.dataset.moduleId;
            if (moduleId) {
                e.dataTransfer.effectAllowed = 'copy';
                e.dataTransfer.setData('moduleId', moduleId);
            }
        }

        function handleModuleLoaderDragEnd(e) {
            // Cleanup if needed
        }

    </script>
    
    <!-- MODULES FLOATING MENU -->
    <div class="modules-menu">
        <button class="modules-menu-btn" onclick="toggleModulesMenu()" title="√ñppna moduler f√∂r drag & drop">üì¶</button>
        <div id="modules-popup" class="modules-menu-popup">
            <div class="modules-menu-header">üîß Tillg√§ngliga Moduler</div>
            <div id="modules-list-popup"></div>
        </div>
    </div>

    <script>
        // MODULES FLOATING MENU FUNCTIONALITY
        function toggleModulesMenu() {
            const popup = document.getElementById('modules-popup');
            popup.classList.toggle('show');
            if (popup.classList.contains('show')) {
                renderModulesPopup();
            }
        }

        function renderModulesPopup() {
            const container = document.getElementById('modules-list-popup');
            if (!container) return;

            // If catalog not loaded yet, attempt to fetch it now
            if(!moduleCatalog || Object.keys(moduleCatalog).length === 0) {
                try {
                    const res = await fetch('/modules_catalog.json');
                    const data = await res.json();
                    moduleCatalog = data.modules;
                    moduleCategories = data.categories;
                    renderCategoryFilter();
                    renderAllModules();
                } catch(e) {
                    container.innerHTML = '<p style="color:#f87171; padding:8px;">Kunde inte ladda moduler</p>';
                    return;
                }
            }

            container.innerHTML = Object.entries(moduleCatalog).map(([key, mod]) => {
                const cat = moduleCategories[mod.category] || {};
                return `<div 
                    class="module-item-drag" 
                    draggable="true" 
                    data-module-type="${key}"
                    ondragstart="handleModuleTypeDragStart(event)"
                    ondragend="handleModuleTypeDragEnd(event)"
                    title="${mod.description}"
                >
                    ${cat.icon || 'üì¶'} <strong>${key}</strong>
                    <div style="font-size:11px; color:#666; margin-top:4px;">${mod.description}</div>
                </div>`;
            }).join('');
        }

        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.querySelector('.modules-menu');
            const popup = document.getElementById('modules-popup');
            if (menu && !menu.contains(e.target) && popup.classList.contains('show')) {
                popup.classList.remove('show');
            }
        });
    </script>
    <script src="/js/modules_loader.js"></script>
    <script src="/src/js/conversations_ui.js"></script>
    <script src="/js/modules.js"></script>

    <!-- GLOBAL NAVIGATION MENU -->
    <div id="navMenuOverlay" onclick="toggleNavMenu()"></div>
    <nav id="navMenu">
        <div class="nav-menu-header">
            <h2>NAVIGERA</h2>
            <button class="nav-menu-close" onclick="toggleNavMenu()">‚úï</button>
        </div>
        <ul class="nav-menu-items">
            <li><a href="index.html">üìä PORTAL</a></li>
            <li><a href="console.html" class="active">‚öôÔ∏è ADMIN KONSOL</a></li>
            <li><a href="chat.html">üí¨ LIVE CHAT</a></li>
        </ul>
    </nav>

    <script>
        function toggleNavMenu() {
            const menu = document.getElementById('navMenu');
            const overlay = document.getElementById('navMenuOverlay');
            menu.classList.toggle('open');
            overlay.classList.toggle('open');
        }

        // St√§ng meny n√§r man klickar p√• en l√§nk
        document.querySelectorAll('#navMenu a').forEach(link => {
            link.addEventListener('click', () => toggleNavMenu());
        });

        // St√§ng meny n√§r man klickar p√• overlay
        document.getElementById('navMenuOverlay').addEventListener('click', toggleNavMenu);
    </script>
    <!-- GLOBAL NAVIGATION SYSTEM -->
    <script src="js/global_nav_menu.js" defer></script>

    <!-- COMPLETE NAVIGATION SYSTEM -->
    <link rel="stylesheet" href="css/navigation.css">
    <script src="js/navigation_hub.js" defer></script>
<script src="/js/global_nav.js"></script>
</body>
</html>
