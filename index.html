<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <title>ÆSI PORTAL v6.0 | CHRONOS EDITOR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* LAYOUT: 3 Kolumner (Chatt | Cockpit | Minne) */
        body { background: #050505; color: #e5e5e5; height: 100vh; display: grid; grid-template-columns: 300px 1fr 350px; font-family: 'Courier New', monospace; overflow: hidden; }
        
        /* GEMENSAMMA STILAR */
        .panel { display: flex; flex-direction: column; background: #0a0a0a; border-right: 1px solid #222; }
        .header { padding: 15px; border-bottom: 1px solid #222; font-weight: bold; display: flex; align-items: center; gap: 10px; color: #fff; background: #000; }
        .content { flex: 1; overflow-y: auto; padding: 15px; }
        
        /* VÄNSTER: CHATT (Archivarius) */
        .msg { padding: 10px; margin-bottom: 10px; background: #111; border-radius: 4px; border-left: 2px solid #333; font-size: 0.8rem; line-height: 1.4; }
        .msg.archivarius { border-left-color: #facc15; background: rgba(250, 204, 21, 0.05); color: #fef08a; }
        .chat-input-area { padding: 15px; border-top: 1px solid #222; background: #000; }
        
        /* MITTEN: COCKPIT (Kontroller) */
        .cockpit-panel { background: #080808; display: flex; flex-direction: column; }
        .preview-box { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #444; }
        .control-deck { padding: 20px; background: #111; border-top: 1px solid #333; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        label { display: block; font-size: 0.65rem; color: #666; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; font-weight: bold; }
        select, input[type="text"] { width: 100%; background: #000; border: 1px solid #333; padding: 10px; color: #fff; outline: none; font-family: inherit; font-size: 0.8rem; }
        select:focus, input:focus { border-color: #6366f1; }

        .action-btn { background: #1e1b4b; color: #818cf8; border: 1px solid #4338ca; padding: 15px; width: 100%; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.2s; }
        .action-btn:hover { background: #312e81; color: #fff; box-shadow: 0 0 15px rgba(99, 102, 241, 0.3); }

        /* HÖGER: MINNET (Filväljare) */
        .memory-panel { border-right: none; border-left: 1px solid #222; }
        .file-list { padding: 0; }
        .file-row { display: flex; align-items: center; gap: 10px; padding: 8px 15px; border-bottom: 1px solid #1a1a1a; font-size: 0.75rem; color: #888; cursor: pointer; transition: background 0.1s; }
        .file-row:hover { background: #151515; color: #fff; }
        .file-row input[type="checkbox"] { accent-color: #6366f1; cursor: pointer; }
        
        /* RESULTAT LÄNKAR */
        .result-link { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px; background: #000; border: 1px solid #333; color: #4ade80; text-decoration: none; margin-top: 5px; font-size: 0.8rem; transition: all 0.2s; width: 100%; }
        .result-link:hover { border-color: #4ade80; background: #052e16; }
        .result-link.txt { color: #60a5fa; }
        .result-link.txt:hover { border-color: #60a5fa; background: #172554; }

    </style>
</head>
<body>

    <!-- 1. VÄNSTER: ARCHIVARIUS CHATT -->
    <div class="panel">
        <div class="header" style="color: #facc15;">
            <i data-lucide="bot" class="w-4 h-4"></i> ARCHIVARIUS
        </div>
        <div id="chat-log" class="content">
            <div class="msg archivarius">
                <strong>SYSTEM:</strong> Chronos Editor v6.0 online.<br>
                Jag är redo att filtrera tidslinjen. Välj dina parametrar i Cockpiten.
            </div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chat-in" placeholder="Kommando till arkivet..." onkeydown="handleChat(event)">
        </div>
    </div>

    <!-- 2. MITTEN: CHRONOS COCKPIT -->
    <div class="cockpit-panel">
        <div class="preview-area preview-box">
            <div id="weave-status" class="text-center">
                <i data-lucide="layers" class="w-16 h-16 mx-auto mb-4 opacity-20"></i>
                <div class="text-xs text-gray-500 uppercase tracking-widest">Vävstatus: Väntar</div>
            </div>
            <div id="download-links" class="w-64 mt-6"></div>
        </div>
        
        <div class="control-deck">
            <!-- Inställningar -->
            <div>
                <label><i data-lucide="layout-template" class="inline w-3 h-3 mr-1"></i> FORMAT MALL</label>
                <select id="template-select" class="mb-4">
                    <option value="standard">Standard (Master History)</option>
                    <option value="legal">⚖️ Lagbok & Protokoll (Röd)</option>
                    <option value="story">🌲 Narrativ Krönika (Grön)</option>
                </select>
                
                <label><i data-lucide="filter" class="inline w-3 h-3 mr-1"></i> NOD FILTER (T.ex. "Ernie")</label>
                <input type="text" id="node-filter" placeholder="Lämna tomt för alla noder...">
            </div>
            
            <!-- Startknapp -->
            <div class="flex flex-col justify-end">
                <button onclick="triggerWeave()" class="action-btn">
                    <i data-lucide="loom" class="w-5 h-5"></i> STARTA VÄVAREN
                </button>
            </div>
        </div>
    </div>

    <!-- 3. HÖGER: MINNESBANK (FILVÄLJARE) -->
    <div class="memory-panel">
        <div class="header" style="color: #6366f1; justify-content: space-between;">
            <span class="flex items-center gap-2"><i data-lucide="database" class="w-4 h-4"></i> MINNET</span>
            <button onclick="toggleAll()" class="text-[10px] bg-[#111] px-2 py-1 border border-[#333] hover:bg-[#222]">VÄLJ ALLA</button>
        </div>
        <div id="memory-list" class="content file-list">
            <!-- Filer laddas här -->
            <div class="text-center p-4 text-gray-600 text-xs">Laddar minnesbank...</div>
        </div>
        <div class="p-2 border-t border-[#222] bg-[#000] text-[10px] text-gray-500 flex justify-between">
            <span id="file-count">0 filer</span>
            <span onclick="loadMem()" class="cursor-pointer hover:text-white">REFRESH</span>
        </div>
    </div>

    <script>
        lucide.createIcons();
        const API = window.location.origin;

        // --- 1. LADDA OCH VISA FILER ---
        async function loadMem() {
            const list = document.getElementById('memory-list');
            try {
                const r = await fetch(API + '/memory');
                const d = await r.json();
                list.innerHTML = '';
                document.getElementById('file-count').innerText = `${d.count} objekt`;
                
                d.files.forEach(f => {
                    // Vi visar bara JSON-filer för vävning, men visar andra som info
                    const isWeavable = f.type === 'json';
                    const icon = isWeavable ? 'file-json' : (f.type === 'link' ? 'link' : 'file-text');
                    const opacity = isWeavable ? '1' : '0.4';
                    
                    const row = document.createElement('label');
                    row.className = 'file-row';
                    row.style.opacity = opacity;
                    
                    // Endast JSON får checkbox
                    const checkbox = isWeavable ? `<input type="checkbox" class="file-check" value="${f.name}" checked>` : `<i data-lucide="lock" class="w-3 h-3 text-gray-600"></i>`;
                    
                    row.innerHTML = `
                        ${checkbox}
                        <i data-lucide="${icon}" class="w-3 h-3 text-gray-500"></i>
                        <span class="truncate" title="${f.name}">${f.name}</span>
                    `;
                    list.appendChild(row);
                });
                lucide.createIcons();
            } catch(e) {
                list.innerHTML = '<div class="text-red-500 p-4 text-xs">Kunde inte nå Brunnen. Är servern igång?</div>';
            }
        }

        // --- 2. VÄVAREN (LOGIK) ---
        async function triggerWeave() {
            const statusDiv = document.getElementById('weave-status');
            const linksDiv = document.getElementById('download-links');
            
            // UI Feedback
            statusDiv.innerHTML = '<div class="text-yellow-500 animate-pulse font-bold">VÄVER TRÅDAR...</div><div class="text-xs text-gray-600 mt-2">Analyserar tidslinjer & filter</div>';
            linksDiv.innerHTML = '';

            // Hämta inställningar
            const template = document.getElementById('template-select').value;
            const filterNode = document.getElementById('node-filter').value;
            
            // Hämta valda filer
            const checkboxes = document.querySelectorAll('.file-check:checked');
            const selectedFiles = Array.from(checkboxes).map(cb => cb.value);
            
            // Logga i chatten
            addLog('DIRIGENT', `Initiera vävning. Mall: ${template}. Filer: ${selectedFiles.length || 'ALLA'}.`);

            try {
                const res = await fetch(API + '/weave', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        template: template,
                        filter_node: filterNode,
                        files: selectedFiles.length > 0 ? selectedFiles : [] 
                    })
                });
                
                const data = await res.json();
                
                if (data.status === 'success') {
                    statusDiv.innerHTML = `<div class="text-green-500 font-bold mb-1">VÄVNING KLAR</div><div class="text-[10px] text-gray-500">${data.message}</div>`;
                    
                    linksDiv.innerHTML = `
                        <a href="/public/FULL_HISTORY.html" target="_blank" class="result-link">
                            <i data-lucide="book-open" class="w-4 h-4"></i> ÖPPNA BOKEN (HTML)
                        </a>
                        <a href="/public/FULL_CONTEXT.txt" target="_blank" class="result-link txt">
                            <i data-lucide="cpu" class="w-4 h-4"></i> AI CONTEXT (TXT)
                        </a>
                    `;
                    lucide.createIcons();
                    addLog('ARCHIVARIUS', `Vävning slutförd. ${data.message}`);
                } else {
                    throw new Error(data.error || "Okänt fel");
                }
            } catch (err) {
                statusDiv.innerHTML = '<div class="text-red-500 font-bold">KRITISKT FEL</div>';
                addLog('SYSTEM', `Fel vid vävning: ${err.message}`);
            }
        }

        // --- 3. CHATT LOGIK ---
        async function handleChat(e) {
            if(e.key === 'Enter') {
                const txt = e.target.value;
                if(!txt) return;
                addLog('DIRIGENT', txt);
                e.target.value = '';
                
                try {
                    const r = await fetch(API + '/chat', { method:'POST', body: JSON.stringify({text:txt}) });
                    const d = await r.json();
                    addLog(d.node, d.reply);
                } catch(e) {
                    addLog('SYSTEM', 'Kunde inte nå Archivarius.');
                }
            }
        }

        function addLog(who, txt) {
            const l = document.getElementById('chat-log');
            const cls = (who === 'ARCHIVARIUS' || who === 'SYSTEM') ? 'msg archivarius' : 'msg';
            l.innerHTML += `<div class="${cls}"><strong>${who}:</strong> ${txt}</div>`;
            l.scrollTop = l.scrollHeight;
        }
        
        function toggleAll() {
            const boxes = document.querySelectorAll('.file-check');
            const allChecked = Array.from(boxes).every(b => b.checked);
            boxes.forEach(b => b.checked = !allChecked);
        }

        // Initiera vid start
        loadMem();
    </script>
</body>
</html>