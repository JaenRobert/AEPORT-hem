<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Drag & Drop Modules ‚Äî AEPORT</title>
  <style>
    :root{--gap:12px;--bg:#0b1020;--card:#111827;--muted:#9ca3af;--accent:#3b82f6}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071026 0%,#041024 100%);color:#e5e7eb;font-family:Inter,Segoe UI,system-ui,Arial}
    .wrap{display:flex;gap:16px;padding:18px;height:100%;box-sizing:border-box}
    .sidebar{width:300px;background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;display:flex;flex-direction:column}
    .sidebar h2{margin:6px 0 8px;font-size:16px}
    .modules-list{overflow:auto;flex:1;display:grid;grid-template-columns:1fr;gap:10px;padding-right:6px}
    .module{background:var(--card);padding:8px;border-radius:8px;cursor:grab;display:flex;align-items:center;gap:8px;border:1px solid rgba(255,255,255,0.03)}
    .module img{width:28px;height:28px;border-radius:6px;background:rgba(255,255,255,0.02)}
    .module .meta{font-size:13px}
    .main{flex:1;display:flex;flex-direction:column;gap:var(--gap)}
    .grid{display:grid;grid-template-rows:auto 1fr auto;gap:var(--gap);height:100%}
    .box{background:rgba(255,255,255,0.02);border-radius:8px;padding:10px;min-height:70px;border:2px dashed transparent;display:flex;flex-wrap:wrap;gap:8px}
    .box.dragover{border-color:var(--accent)}
    .top,.bottom{min-height:80px}
    .middle{display:grid;grid-template-columns:1fr 3fr 1fr;gap:var(--gap);height:100%}
    .card{background:#0f1724;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.03);display:flex;gap:8px;align-items:center}
    .card small{color:var(--muted)}
    .toolbar{display:flex;gap:8px;align-items:center}
    button{background:var(--accent);color:#fff;padding:6px 10px;border-radius:6px;border:0;cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
    .empty{opacity:.5;font-size:13px}
  </style>
  <script src="/js/menu.js"></script>
</head>
<body>
  <div class="wrap">
    <aside class="sidebar">
      <h2>Modules</h2>
      <div class="muted">Drag modules into any box. Drop to apply.</div>
      <div class="modules-list" id="modulesList">Loading modules‚Ä¶</div>
      <div id="modulePreview" style="margin-top:10px;background:rgba(255,255,255,0.02);border-radius:6px;padding:8px;min-height:80px;">
        <div class="muted">Preview will appear here when hovering modules.</div>
      </div>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button id="resetBtn">Reset layout</button>
        <button id="saveBtn">Save layout</button>
      </div>

      <hr style="margin:10px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)">
      <h3 style="margin:6px 0">C12 Status</h3>
      <div class="muted">Connect the panel to C12_STATUS and export.</div>
      <div id="c12Panel" style="margin-top:8px;display:flex;flex-direction:column;gap:6px">
        <div id="c12Status" class="muted">Status: <span id="c12StatusVal">unknown</span></div>
        <div style="display:flex;gap:6px">
          <button id="fetchC12">Fetch</button>
          <button id="loadJSONAll">Load JSON_ALL_C</button>
          <button id="exportBtn">Export (S)</button>
        </div>
        <label style="margin-top:6px"><input type="checkbox" id="pulseExport"> Allow pulse-export</label>
        <div class="muted" style="font-size:12px">Click <strong>Export (S)</strong> or press the <strong>S</strong> key to export layout to file (and attempt POST to <code>/export</code> on the local server).</div>
      </div>
    </aside>

    <main class="main">
      <div class="grid">
        <div class="box top" id="box-top">Top area ‚Äî drop here</div>

        <div class="middle">
          <div class="box" id="box-left">üúÄ Sagan (Ber√§ttande)</div>
          <div class="box" id="box-center">üúÅ Min (Ditt)</div>
          <div class="box" id="box-right">üúÇ Mask (Nej)</div>
        </div>

        <div class="box bottom" id="box-bottom">Bottom area ‚Äî drop here</div>
      </div>
    </main>
  </div>

  <script src="../nodes.js"></script>
  <script>
    // Basic drag/drop using nodes.js (exposes AESI_NODES / nodes)
    const modulesList = document.getElementById('modulesList');
    const modulePreviewEl = document.getElementById('modulePreview');
    const boxes = ['box-top','box-left','box-center','box-right','box-bottom'].map(id=>document.getElementById(id));
    // store placeholders so loadLayout can restore default text when empty
    const boxPlaceholders = {};
    boxes.forEach(b=> boxPlaceholders[b.id] = b.innerHTML);

    // Render modules from nodes.js if available
    const nodes = window.AESI_NODES || (window.nodes && window.nodes.nodes) || [];
    function renderModules(){
      modulesList.innerHTML='';
      nodes.forEach(n=>{
        const el=document.createElement('div');
        el.className='module';
        el.draggable=true;
        el.dataset.nodeId=n.id;
        el.innerHTML=`<img alt="${n.name}" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='28' height='28'><rect width='28' height='28' fill='${encodeURIComponent(n.color)}'/></svg>'><div class=meta><strong>${n.name}</strong><div class=muted>${n.role} ‚Ä¢ ${n.origin}</div></div>`;
        el.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/node-id', n.id); e.dataTransfer.effectAllowed='copy'; el.style.opacity='0.6'; });
        el.addEventListener('dragend', ()=>{ el.style.opacity='1'; });
        // preview on hover/click
        el.addEventListener('mouseenter', ()=> showPreview(n));
        el.addEventListener('mouseleave', ()=> clearPreview());
        el.addEventListener('click', ()=> showPreview(n));
        modulesList.appendChild(el);
      })
    }

    function allowDrop(e){ e.preventDefault(); e.currentTarget.classList.add('dragover'); e.dataTransfer.dropEffect='copy'; }
    function leaveDrop(e){ e.currentTarget.classList.remove('dragover'); }
    function handleDrop(e){
      e.preventDefault();
      const nodeId = e.dataTransfer.getData('text/node-id');
      const cardId = e.dataTransfer.getData('text/node-card');
      e.currentTarget.classList.remove('dragover');

      // Dropped from sidebar (copy)
      if(nodeId){
        const node = nodes.find(x=>x.id==nodeId);
        if(!node) return;
        const card=document.createElement('div');
        card.className='card';
        card.draggable=true;
        card.dataset.nodeId=node.id;
        card.innerHTML = `<div style="width:34px;height:34px;border-radius:6px;background:${node.color}"></div><div><strong>${node.name}</strong><div><small>${node.role}</small></div></div>`;
        attachCardHandlers(card, node);
        e.currentTarget.appendChild(card);
        saveLayout();
        return;
      }

      // Moved existing card between boxes (move)
      if(cardId){
        const existing = document.querySelector(`.card[data-node-id="${cardId}"]`);
        if(existing){
          e.currentTarget.appendChild(existing);
          saveLayout();
          return;
        }
      }
    }

    // Accept moving cards between boxes and back to sidebar
    modulesList.addEventListener('dragover', e=>{ e.preventDefault(); e.dataTransfer.dropEffect='move'; });
    modulesList.addEventListener('drop', e=>{
      e.preventDefault();
      const id = e.dataTransfer.getData('text/node-card');
      if(!id) return;
      // Remove the original card from its parent (move back to sidebar)
      const existing = document.querySelector(`.card[data-node-id="${id}"]`);
      if(existing) existing.remove();
      // Re-render modules list so the sidebar shows the item again
      renderModules();
      saveLayout();
    });

    // helper to attach card handlers
    function attachCardHandlers(card, node){
      // allow dragging card back to modules list
      card.addEventListener('dragstart', ev=>{ ev.dataTransfer.setData('text/node-card', node.id); ev.dataTransfer.effectAllowed='move'; card.style.opacity='0.6'; });
      card.addEventListener('dragend', ()=>card.style.opacity='1');
      // click to preview
      card.addEventListener('click', ()=> showPreview(node));
    }

    boxes.forEach(b=>{
      b.addEventListener('dragover', allowDrop);
      b.addEventListener('dragenter', allowDrop);
      b.addEventListener('dragleave', leaveDrop);
      b.addEventListener('drop', handleDrop);
    });

    // Persistence
    function saveLayout(){
      const state={};
      boxes.forEach(b=>{ state[b.id] = Array.from(b.querySelectorAll('.card')).map(c=>c.dataset.nodeId); });
      localStorage.setItem('aesi_modules_layout', JSON.stringify(state));
    }
    function loadLayout(){
      const raw = localStorage.getItem('aesi_modules_layout');
      if(!raw) return;
      try{
        const state=JSON.parse(raw);
        boxes.forEach(b=>{
          // clear but keep placeholder if no cards will be added
          b.innerHTML='';
          const list = state[b.id]||[];
          if(!list.length){
            b.innerHTML = boxPlaceholders[b.id] || '';
          }
          list.forEach(id=>{
            const node = nodes.find(x=>x.id==id);
            if(node){
              const card=document.createElement('div');
              card.className='card';
              card.dataset.nodeId=node.id;
              card.innerHTML = `<div style="width:34px;height:34px;border-radius:6px;background:${node.color}"></div><div><strong>${node.name}</strong><div><small>${node.role}</small></div></div>`;
              card.draggable=true;
              attachCardHandlers(card, node);
              b.appendChild(card);
            }
          });
        });
      }catch(e){ console.warn('Failed to load layout',e); }
    }

    document.getElementById('resetBtn').addEventListener('click', ()=>{ if(confirm('Clear saved layout?')){ localStorage.removeItem('aesi_modules_layout'); boxes.forEach(b=> b.innerHTML = boxPlaceholders[b.id] || ''); renderModules(); } });
    document.getElementById('saveBtn').addEventListener('click', ()=>{ saveLayout(); alert('Layout saved'); });

    // initial
    renderModules(); loadLayout();

    // Preview helpers
    function showPreview(node){
      if(!modulePreviewEl) return;
      modulePreviewEl.innerHTML = `
        <div style="display:flex;gap:8px;align-items:flex-start">
          <div style="width:44px;height:44px;border-radius:8px;background:${node.color}"></div>
          <div>
            <div style="font-weight:700;color:#fff">${node.name}</div>
            <div style="color:var(--muted);font-size:13px">${node.role} ‚Ä¢ ${node.origin||''}</div>
            <div style="margin-top:8px;color:#cbd5e1;font-size:13px">${node.description||node.name}</div>
          </div>
        </div>
      `;
    }

    function clearPreview(){
      if(!modulePreviewEl) return;
      modulePreviewEl.innerHTML = '<div class="muted">Preview will appear here when hovering modules.</div>';
    }

    // --- C12 + export features ---
    const c12StatusVal = document.getElementById('c12StatusVal');
    async function fetchC12Status(){
      // try a local endpoint first, fallback to localStorage
      try{
        const r = await fetch('/c12/status');
        if(r.ok){ const j = await r.json(); c12StatusVal.textContent = j.status || JSON.stringify(j); localStorage.setItem('C12_STATUS', JSON.stringify(j)); return j; }
      }catch(e){ /* ignore */ }
      const raw = localStorage.getItem('C12_STATUS');
      if(raw){ try{ const j=JSON.parse(raw); c12StatusVal.textContent = j.status||'from-storage'; return j; }catch(e){} }
      c12StatusVal.textContent = 'unavailable';
      return null;
    }

    document.getElementById('fetchC12').addEventListener('click', ()=>{ fetchC12Status(); });

    document.getElementById('loadJSONAll').addEventListener('click', ()=>{
      const raw = localStorage.getItem('JSON_ALL_C');
      if(!raw){ alert('No JSON_ALL_C found in localStorage'); return; }
      try{ const obj = JSON.parse(raw); console.log('JSON_ALL_C',obj); alert('JSON_ALL_C loaded to console'); }catch(e){ alert('Failed to parse JSON_ALL_C') }
    });

    async function exportLayout(){
      const layout = {};
      boxes.forEach(b=> layout[b.id] = Array.from(b.querySelectorAll('.card')).map(c=>c.dataset.nodeId));
      const payload = {
        protocol: 'C12',
        status: 'active',
        sync: 'realflow',
        fallback_ready: true,
        timestamp: new Date().toISOString(),
        layout,
        nodes: nodes.map(n=>({id:n.id,name:n.name,role:n.role,origin:n.origin})),
        pulse_export: document.getElementById('pulseExport').checked
      };

      // Download locally
      const blob = new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'export.jsn';
      document.body.appendChild(a);
      a.click();
      a.remove();

      // Try to POST to server /export endpoint
      try{
        const r = await fetch('/export', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
        if(r.ok){ alert('Exported to server /export (and downloaded file)'); return; }
        console.warn('Server export failed', r.status);
        alert('Downloaded export.jsn; server export returned '+r.status);
      }catch(e){ console.warn('Server export error',e); alert('Downloaded export.jsn; server export failed (no endpoint)'); }
    }

    document.getElementById('exportBtn').addEventListener('click', exportLayout);

    // Keyboard shortcut: S to export
    document.addEventListener('keydown', (e)=>{ if(e.key.toLowerCase()==='s' && !e.ctrlKey && !e.metaKey){ e.preventDefault(); exportLayout(); } });

  </script>
</body>
</html>
