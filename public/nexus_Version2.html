<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ÆSI NEXUS — Live Console</title>
  <style>
    :root {
      --bg: #0b0b0d;
      --panel: #0f1720;
      --accent: #7c3aed;
      --green: #10b981;
      --muted: #94a3b8;
      --log: #e6f0ff;
    }
    html,body { height:100%; margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); color:#e6eef8; }
    .app { display:flex; flex-direction:column; max-width:900px; margin:24px auto; height: calc(100vh - 48px); gap:12px; padding:12px; }
    header { display:flex; align-items:center; gap:12px; }
    h1 { margin:0; font-size:1.2rem; color:var(--accent); }
    #status { margin-left:auto; font-size:0.85rem; color:var(--muted); }

    .main { display:flex; gap:12px; flex:1; min-height:0; }
    .pane { background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.03); padding:12px; border-radius:8px; overflow:auto; }
    .chat { flex: 1 1 60%; display:flex; flex-direction:column; min-width:0; }
    .console { width: 320px; flex: 0 0 320px; display:flex; flex-direction:column; gap:8px; }

    .messages { flex:1; overflow:auto; padding-right:8px; }
    .message { margin-bottom:10px; }
    .msg-user { color:#cbd5e1; background: rgba(255,255,255,0.02); padding:8px 10px; border-radius:6px; display:inline-block; }
    .msg-ai { color:#0b1120; background: linear-gradient(90deg,#a78bfa,#7c3aed); padding:8px 10px; border-radius:6px; display:inline-block; }
    .log { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; font-size:0.85rem; color:var(--log); background: rgba(255,255,255,0.02); padding:6px 8px; border-radius:6px; display:block; }

    .inputRow { display:flex; gap:8px; margin-top:8px; }
    input[type="text"] { flex:1; padding:10px; border-radius:6px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:inherit; outline:none; }
    button { padding:10px 12px; border-radius:6px; border:0; background:var(--accent); color:white; cursor:pointer; }
    button.secondary { background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted); }

    .sys { font-size:0.9rem; color:var(--muted); margin-bottom:6px; }
    .small { font-size:0.9rem; color:var(--muted); }

  </style>
  <script src="/js/menu.js"></script>
</head>
<body>
  <div class="app">
    <header>
      <h1>ÆSI NEXUS — Live Chat & Console</h1>
      <div id="status">Status: <span id="conn">Disconnected</span></div>
    </header>

    <div class="main">
      <section class="pane chat">
        <div class="sys">Tip: Skriv vanlig text för AI-chat. Skriv /build (eller /bygg) för att köra ett simulated build.</div>
        <div id="messages" class="messages" aria-live="polite"></div>

        <div class="inputRow">
          <input id="input" type="text" placeholder="Skriv meddelande eller /kommando..." />
          <button id="sendBtn">Skicka</button>
          <button id="clearBtn" class="secondary">Rensa</button>
        </div>
      </section>

      <aside class="pane console">
        <div class="small">Server Logs</div>
        <div id="logs" style="overflow:auto; flex:1; margin-top:8px;"></div>
        <div style="margin-top:8px;">
          <button id="connectBtn" class="secondary">Connect</button>
          <button id="disconnectBtn" class="secondary">Disconnect</button>
        </div>
      </aside>
    </div>
  </div>

  <script>
    // nexus.html client-side WebSocket logic
    (function () {
      const RECONNECT_DELAY = 3000; // ms
      const WS_PORT = 8765;
      const host = location.hostname || 'localhost';
      const WS_URL = `ws://${host}:${WS_PORT}`;
      let ws = null;
      let manualClose = false;
      let reconnectTimeout = null;

      const connEl = document.getElementById('conn');
      const messagesEl = document.getElementById('messages');
      const logsEl = document.getElementById('logs');
      const inputEl = document.getElementById('input');
      const sendBtn = document.getElementById('sendBtn');
      const clearBtn = document.getElementById('clearBtn');
      const connectBtn = document.getElementById('connectBtn');
      const disconnectBtn = document.getElementById('disconnectBtn');

      function setStatus(text, color) {
        connEl.textContent = text;
        connEl.style.color = color || '';
      }

      function appendMessage(text, cls = 'msg-user') {
        const el = document.createElement('div');
        el.className = 'message';
        const bubble = document.createElement('div');
        bubble.className = cls === 'msg-ai' ? 'msg-ai' : 'msg-user';
        bubble.textContent = text;
        el.appendChild(bubble);
        messagesEl.appendChild(el);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      function appendLog(text) {
        const el = document.createElement('div');
        el.className = 'log';
        el.textContent = text;
        logsEl.appendChild(el);
        logsEl.scrollTop = logsEl.scrollHeight;
      }

      function connect() {
        if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) {
          console.log('Already connected/connecting.');
          return;
        }
        manualClose = false;
        setStatus('Connecting...', 'orange');
        ws = new WebSocket(WS_URL);

        ws.addEventListener('open', () => {
          setStatus('Connected', '#34d399');
          appendLog('Connected to edge server.');
        });

        ws.addEventListener('message', (ev) => {
          const data = ev.data || '';
          if (data.startsWith('dirigentCHAT_MSG:')) {
            const payload = data.substring(data.indexOf(':') + 1).trim();
            appendMessage(payload, 'msg-ai');
          } else if (data.startsWith('reflexSERVER_LOG:')) {
            const payload = data.substring(data.indexOf(':') + 1).trim();
            appendLog(payload);
          } else {
            appendLog('[UNKNOWN] ' + data);
          }
        });

        ws.addEventListener('close', (ev) => {
          setStatus('Disconnected', 'red');
          appendLog('Disconnected from server.');
          if (!manualClose) scheduleReconnect();
        });

        ws.addEventListener('error', (ev) => {
          console.error('WebSocket error', ev);
          appendLog('WebSocket error (see console).');
        });
      }

      function scheduleReconnect() {
        if (reconnectTimeout) return;
        appendLog(`Reconnecting in ${RECONNECT_DELAY}ms...`);
        reconnectTimeout = setTimeout(() => {
          reconnectTimeout = null;
          appendLog('Attempting reconnect...');
          connect();
        }, RECONNECT_DELAY);
      }

      function disconnect() {
        manualClose = true;
        if (reconnectTimeout) {
          clearTimeout(reconnectTimeout);
          reconnectTimeout = null;
        }
        if (ws) {
          try { ws.close(); } catch (e) { /* ignore */ }
        }
      }

      function sendCurrentInput() {
        const text = inputEl.value.trim();
        if (!text) return;
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          appendLog('Not connected. Message not sent.');
          return;
        }

        if (text.startsWith('/')) {
          ws.send('dirigentCMD:' + text);
          appendMessage(text, 'msg-user');
        } else {
          ws.send('CHAT:' + text);
          appendMessage(text, 'msg-user');
        }
        inputEl.value = '';
      }

      // Event wiring
      sendBtn.addEventListener('click', sendCurrentInput);
      inputEl.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendCurrentInput();
      });
      clearBtn.addEventListener('click', () => {
        messagesEl.innerHTML = '';
      });
      connectBtn.addEventListener('click', connect);
      disconnectBtn.addEventListener('click', disconnect);

      // Auto-connect on load
      connect();

      // Expose for debugging
      window.__aesi = { connect, disconnect, sendCurrentInput };
    })();
  </script>
</body>
</html>